name: github action build & CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
      tags:
        description: 'Test scenario tags'

jobs:
  gapc_ubuntu:
    strategy:
      matrix:
        # https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners
        # as of 21st Sep 2021, ubuntu-16.04 is no longer supported by github actions: https://github.blog/changelog/2021-04-29-github-actions-ubuntu-16-04-lts-virtual-environment-will-be-removed-on-september-20-2021/
        os: [ubuntu-18.04]
    runs-on: ${{ matrix.os }}
    steps:
    - name: Update apt
      run: sudo apt-get update
    - name: Install dependencies
      run: sudo apt-get install flex bison make libboost-all-dev libgsl-dev ghc python3 python3-pip cabal-install libghc-random-dev

    ## cabal install random doesn't seem to work anymore: https://stackoverflow.com/questions/11068185/ubuntu-haskell-ghci-7-4-1-could-not-find-module-system-random
    ##- name: update cabal
    ##  run: cabal update
    ##- name: add random Haskell lib
    ##  run: cabal install --lib random
    ##- uses: actions/checkout@v2
    ##- name: debugging
    ##  run: cd testdata/paraltest && mkdir temp && cd temp && ghc --make ../AdpfMain.lhs -i.. -hidir ./GHC -odir ./GHC -o AdpfMain
    ## we might have to change that in the (near?) future, but it should work for now:
    ## https://cabal.readthedocs.io/en/latest/nix-local-build-overview.html
    - name: install Haskell random lib
      run: |
        which -a cabal
        cabal --version
        /usr/bin/cabal update
        

    - name: Checkout truth
      run: git clone --branch master https://github.com/jlab/gapc-test-suite.git $GITHUB_WORKSPACE/../gapc-test-suite

    - uses: actions/checkout@v2
    - name: configure
      run: ./configure --prefix $GITHUB_WORKSPACE
    - name: make
      run: make -j 2
    - name: make install
      run: sudo make install

    - name: test-paral
      run: make test-paral
