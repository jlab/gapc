name: github action build & CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
      tags:
        description: 'Test scenario tags'

jobs:
  gapc_osx:
    strategy:
      matrix:
        # https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners
        os: [macos-13]
    runs-on: ${{ matrix.os }}
    steps:
    - name: Install dependencies
      run: brew install bison@3.8 cmake boost gsl gnu-sed libomp gmp cabal-install ghc
    - name: update cabal
      run: cabal update
    - name: add random Haskell lib
      run: cabal install --lib random
    #- name: add base Haskell lib containers (prelude, Data.Map, Data.Map.Strict)
    #  run: cabal install --lib base
    - name: Checkout truth
      run: git clone --branch master https://github.com/jlab/gapc-test-suite.git $GITHUB_WORKSPACE/../gapc-test-suite

    - uses: actions/checkout@v3
    - name: configure
      run: ./configure --prefix $GITHUB_WORKSPACE
    - name: patch configuration for OSX
      run: gsed -E "s|^YACC = .+$|YACC = /usr/local/opt/bison@3.8/bin/bison|" -i config.mf && gsed -E "s|^SED = .+$|SED = /usr/local/opt/gnu-sed/libexec/gnubin/sed|" -i config.mf && gsed -E "s/ -D_XOPEN_SOURCE=500 / /" -i config.mf && gsed -E "s/ -std=c\+\+17 / -std=c\+\+11 /" -i config.mf
    - name: make parser
      run: make src/lexer.cc src/parser.cc
    - name: Archive parser
      uses: actions/upload-artifact@v4
      with:
        name: parser
        path: ./
    - name: make
      run: make -j 3
    - name: make install
      run: sudo make install

    - name: test-mod
      run: make test-mod TRUTH_DIR=$GITHUB_WORKSPACE/../gapc-test-suite/Truth TRUTH_SUFFIX=_osx
    - name: test-mod_outside
      run: make -j 2 test-mod_outside TRUTH_DIR=$GITHUB_WORKSPACE/../gapc-test-suite/Truth TRUTH_SUFFIX=_osx
    - name: test-regress
      run: make test-regress TRUTH_DIR=$GITHUB_WORKSPACE/../gapc-test-suite/Truth
    - name: test-ambiguity
      run: make test-ambiguity TRUTH_DIR=$GITHUB_WORKSPACE/../gapc-test-suite/Truth
    - name: test-unit
      run: make test-unit
    - name: test-paral
      run: make test-paral


