name: github action build & CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
      tags:
        description: 'Test scenario tags'

jobs:
  gapc_ubuntu:
    strategy:
      matrix:
        # https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners
        # as of 21st Sep 2021, ubuntu-16.04 is no longer supported by github actions: https://github.blog/changelog/2021-04-29-github-actions-ubuntu-16-04-lts-virtual-environment-will-be-removed-on-september-20-2021/
        os: [ubuntu-18.04]
    runs-on: ${{ matrix.os }}
    steps:
    - name: Update apt
      run: sudo apt-get update
    - name: Install dependencies
      run: sudo apt-get install flex bison make libboost-all-dev libgsl-dev python3 python3-pip

    - name: Checkout truth
      run: git clone --branch master https://github.com/jlab/gapc-test-suite.git $GITHUB_WORKSPACE/../gapc-test-suite

    - uses: actions/checkout@v2
    #- name: configure
    #  run: ./configure --prefix $GITHUB_WORKSPACE
    #- name: make
    #  run: make -j 2
    #- name: make install
    #  run: sudo make install

    #- name: test-mod
    #  run: make test-mod TRUTH_DIR=$GITHUB_WORKSPACE/../gapc-test-suite/Truth TRUTH_SUFFIX=_ubuntu
    #- name: test-regress
    #  run: make test-regress TRUTH_DIR=$GITHUB_WORKSPACE/../gapc-test-suite/Truth
    #- name: test-ambiguity
    #  run: make test-ambiguity TRUTH_DIR=$GITHUB_WORKSPACE/../gapc-test-suite/Truth
    #- name: test-unit
    #  run: make test-unit
    # we need to install Haskell (especially the System.Random lib) for paralell tests, since we compare Haskell ADP with gapc
    - uses: haskell/actions/setup@v1
      id: hstef
    - name: cabal
      run: |
        ${{ steps.hstef.outputs.cabal-exe }} v2-update
        ${{ steps.hstef.outputs.cabal-exe }} v2-install --lib random
        cat $HOME/.cabal/config | grep pack
    - name: test Haskell
      run: |
        cat $HOME/.cabal/config | grep pack
        package_path=$HOME/.cabal/store/ghc-`${{ steps.hstef.outputs.ghc-exe }} --version | rev | cut -d " " -f 1 | rev`/package.db
        echo "package_path >$package_path<"
        cd testdata/paraltest/
        echo "GHC_PACKAGE_PATH >$GHC_PACKAGE_PATH<"
        export GHC_PACKAGE_PATH=$GHC_PACKAGE_PATH:$package_path
        ${{ steps.hstef.outputs.ghc-exe }} --make AdpfMain.lhs
        
        
    #${{ steps.hstef.outputs.ghc-exe }} -package-db $HOME/.cabal/store/ghc-9.2.1/package.db --make -v AdpfMain.lhs
    #- name: test-paral
    #  run: make test-paral
